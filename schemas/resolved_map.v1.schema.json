{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://forge-contracts.amerzel.dev/resolved_map.v1.schema.json",
  "title": "resolved_map.v1",
  "description": "Concrete tile-layer map resolved from a semantic map and a terrain pack. Defines the TC→EC terrain data handoff.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema",
    "mapId",
    "zoneRef",
    "tileSize",
    "origin",
    "width",
    "height",
    "pack",
    "seed",
    "tileLookup",
    "layers",
    "meta"
  ],
  "properties": {
    "schema": {
      "const": "resolved_map.v1"
    },
    "mapId": {
      "type": "string",
      "minLength": 1
    },
    "zoneRef": {
      "type": "string",
      "description": "Zone reference identifier, derived from the semantic map's mapId. Used by EncounterComposer to identify the zone.",
      "minLength": 1
    },
    "tileSize": {
      "type": "integer",
      "description": "Tile size in pixels. Matches the semantic map's tileSize.",
      "minimum": 1
    },
    "origin": {
      "type": "string",
      "description": "Coordinate origin convention. All maps use top-left origin.",
      "enum": ["top-left"]
    },
    "width": {
      "type": "integer",
      "minimum": 1
    },
    "height": {
      "type": "integer",
      "minimum": 1
    },
    "pack": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "packId",
        "version"
      ],
      "properties": {
        "packId": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "seed": {
      "type": "integer"
    },
    "tileLookup": {
      "type": "array",
      "description": "Maps numeric tile IDs (used in layer RLE rows) to enriched tile metadata. Array of objects ordered by id.",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/tileEntry"
      }
    },
    "layers": {
      "type": "array",
      "description": "Layers in bottom-to-top render order (index 0 = farthest back).",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/layer"
      }
    },
    "producer": {
      "$ref": "#/$defs/producer"
    },
    "provenance": {
      "$ref": "#/$defs/provenance"
    },
    "consumed_fields": {
      "type": "array",
      "description": "Intent fields that were actually used during generation. Supports ForgeDirector ↔ ForgeTerrain telemetry feedback loop.",
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "ignored_fields": {
      "type": "array",
      "description": "Intent fields that were present but not used during generation.",
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "coordSystem",
        "tileSize"
      ],
      "properties": {
        "coordSystem": {
          "const": "top-left"
        },
        "tileSize": {
          "type": "integer",
          "minimum": 1
        },
        "generatedAt": {
          "type": "string"
        },
        "generatorVersion": {
          "type": "string"
        },
        "themeSelection": {
          "type": "object",
          "description": "Theme(s) selected by the composer for this run. Present only when the pack defines themes.",
          "additionalProperties": false,
          "required": ["scope"],
          "properties": {
            "scope": {
              "type": "string",
              "enum": ["global", "per-material"],
              "description": "global: one theme for the whole map. per-material: each material may have a different theme."
            },
            "selectedTheme": {
              "type": "string",
              "description": "Theme ID chosen when scope is 'global'.",
              "minLength": 1
            },
            "perMaterial": {
              "type": "object",
              "description": "material ID → chosen theme ID. Used when scope is 'per-material'.",
              "patternProperties": {
                "^[a-z][a-z0-9_-]*$": { "type": "string", "minLength": 1 }
              },
              "additionalProperties": false
            }
          }
        },
        "extensions": {
          "type": "object",
          "description": "Tool-specific extension metadata. Keyed by tool name. Consumers MUST ignore unknown keys.",
          "additionalProperties": true
        }
      }
    }
  },
  "$defs": {
    "tileEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "tileId",
        "kind"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "description": "Numeric tile ID used in RLE-encoded row data.",
          "minimum": 0
        },
        "tileId": {
          "type": "string",
          "minLength": 1
        },
        "kind": {
          "type": "string",
          "enum": [
            "base",
            "transition",
            "fallback"
          ]
        },
        "material": {
          "type": "string",
          "description": "Source material (for base/fallback tiles).",
          "pattern": "^[a-z][a-z0-9_-]*$"
        },
        "boundary": {
          "type": "array",
          "description": "Source boundary pair (for transition tiles). Alphabetical order.",
          "minItems": 2,
          "maxItems": 2,
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_-]*$"
          }
        },
        "transform": {
          "type": "string",
          "enum": [
            "none",
            "flipX",
            "flipY",
            "flipXY",
            "rot90",
            "rot180",
            "rot270"
          ]
        },
        "frameOffset": {
          "type": "integer",
          "description": "Animation frame index (0-based) assigned by the composer. Engines add this to the tile's (col, row) to select the correct atlas frame. Absent means frame 0.",
          "minimum": 0
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "kind": { "const": "transition" } },
            "required": ["kind"]
          },
          "then": {
            "required": ["boundary"]
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "base" } },
            "required": ["kind"]
          },
          "then": {
            "required": ["material"]
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "fallback" } },
            "required": ["kind"]
          },
          "then": {
            "required": ["material"]
          }
        }
      ]
    },
    "layer": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "encoding",
        "rows"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Layer name. Use 'terrain' for the ground layer (not 'base').",
          "minLength": 1
        },
        "encoding": {
          "const": "rle"
        },
        "rows": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[0-9]+:[1-9][0-9]*(,[0-9]+:[1-9][0-9]*)*$"
          }
        },
        "defaultTile": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "producer": {
      "type": "object",
      "description": "Identifies the tool that generated this document.",
      "additionalProperties": false,
      "required": [
        "tool",
        "version",
        "generatedAt"
      ],
      "properties": {
        "tool": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "minLength": 1
        },
        "generatedAt": {
          "type": "string",
          "description": "ISO 8601 timestamp of generation."
        }
      }
    },
    "provenance": {
      "type": "object",
      "description": "Traceability back to the inputs and run that produced this output.",
      "additionalProperties": false,
      "properties": {
        "requestId": {
          "type": "string",
          "minLength": 1
        },
        "runId": {
          "type": "string",
          "minLength": 1
        },
        "semanticMapRef": {
          "type": "string"
        },
        "levelIntentRef": {
          "type": "string"
        }
      }
    }
  }
}
